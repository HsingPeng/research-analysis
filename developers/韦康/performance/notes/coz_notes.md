#Coz:Finding Code that Counts with Causal Profiling-notes
##概要
这篇文章是sosp 2015 best paper，其最大的亮点在于提出了virtual speedup的技术。过去我们做performance bug的检测定位主要有以下几个方法：关键路径，规则匹配，热点分析这几方面，这些方法的本质是寻找耗时比较大的代码段或者说耗时比较大的模式，这是一种正向的思维模式。目前来说，通过这些自动化的手段检测到的performance bug 占比不到10%，大量的performance bug都是通过阅读源码发现的。与上述手段不同的是这篇文章另辟蹊径，从一个全新的思路考虑问题。

现在考虑这样一个问题，在一段代码中，我们优化了该段代码使之性能提高10%，那么会对系统的性能提高多少呢？举一个极端的例子，假设优化的该段代码不在关键路径上，那么该段代码的优化对总体性能的提升为0,即该部分的优化是不能提高系统性能的（这里的性能仅仅指执行时间）。在这个例子中，我们涉及到一个概念(代码优化潜力)：优化该段代码会给系统整体带来多大的性能提升。如果有了代码的优化潜力，我们可以把精力集中到那些优化潜力大的代码上。

如何获取某一段代码的优化潜力呢，这是一个困难点：即我们不可能随意将某段代码随意优化到一定到程度去观测其对系统整体性能的影响。这篇文章的作者提出了virtual speedup的方法。想象这样一个场景：假设有一个程序它有三个部分构成的，分别是线程A，线程B，线程C，现在我们想看看优化线程A使之性能提高40%看看系统整体的性能的提高？前面说了将A性能优化40%不是随意就可以做到的事情（好像就是目前没法做到）。但是有一点我们却可以做到，就是在线程B和线程C中插入合适时长的sleep，使他们的性能下降40%，这样的话等同于将A的性能提高了40%。这个时候通过一定的数学转换就可以看系统线程A优化40%对系统的性能的影响，这就是virtual speedup。当然如何实现virtual speedup并不是一件容易的事。

##效果
根据作者给出的实验数据，利用该技术发现了许多以前尚未发现的performance bug，证明了其有效性。

##难点
虽然virtual speedup的思想简单明了，但是如何在linux上实现virtual speedup并不是一件容易的事情,其实有很多需要考虑的点（比如说粒度是怎么样的，是对线程进行virtual speedup还是深入函数进行virtual speedup，选取多少个点进行virtual speedup，点太少会不会错过那些优化潜力很大的代码段，点太多会不会产生较大的对性能的影响很大）。我到目前为止还没搞清楚其具体实现。

##思考
virtual speedup这篇文章的最大贡献在于它能衡量一段代码优化到底可给以给系统带来多大的收益。这是以前大家都没有尝试过的想法，即使virtual speed很朴素，但这一点很了不起。

首先virtual speedup的技术与关键路径，热点分析这类技术的关系是什么？  
回到一开始举的例子，假设我们优化的代码不在关键路径上，那么它采用virtual speedup来进行优化，不出意外该段的代码的优化潜力接近0。相反的，采用virtual speedup得到一个优化潜力很大的点，那么该段代码应该是位于关键路径上。

在我看来virtual speedup技术同关键路径这些现有的检测方法是不矛盾的，不是很明白作者一开始对关键路径的否定。相比与关键路径来说，virtual speedup技术可以得到一个更加量化的指标，这些指标让开发者更容易集中注意去定位性能bug。

实际上我觉得virtual speedup技术很类似关键路径与热点分析的结合，先找到一条关键路径再分析这条关键路径上的热点，基本上就是优化潜力很大的点。嗯，给我的感觉是一种是殊途同归。

那么相比与关键路径这类分析手段的它的优势在于哪里呢？我想主要在于关键路径的构造上，可能不同的应用有其不同的框架，构造关键路径的插桩点不尽相同，这给关键路径的构造带来了挑战。此外，关键路径也不能量化优化效果。

我现在还没又搞清virtual speedup是怎么做到的，一些细节点无法去思考。

#论文连接
[Coz:Finding Code that Counts with Causal Profiling-notes](https://github.com/openthos/research-analysis/blob/master/developers/%E9%9F%A6%E5%BA%B7/performance/paper/COZ%20Finding%20Code%20that%20Counts%20with%20Causal%20Pro%EF%AC%81ling.pdf)
