## Canopy: 端到端性能跟踪分析系统

### 1.研究情境

用户执行各种各样的操作，例如获取Facebook.com一个页面，通过异构客户端（包括Web浏览器和移动应用程序）、网络和分布式后端服务的复杂执行，从而访问
Facebook，获取不同级别的信息和对应用程序的控制，完成页面的加载。

### 2.Motivation

为解决其中的性能问题，Facebook开发了许多跟踪系统，有单系统的和跨部分系统的，没有跨全部系统的，导致以下问题：

1、进行跨系统性能分析需要了解多个跟踪工具以及何时使用和切换

2、只能关注于特定域，不能一个工具处理所有问题

3、分析类型僵化，用户不能定制

Canopy跨全部系统，工程师可以深度定制，一个工具就可以定位所有问题

### 3.一个实例——利用Canopy工程师如何快速识别UserInput负责300ms页面加载时间延迟

主要思想：当出现性能问题时，其症状可能会在全系统的不同部分显现， 因此，诊断性能问题需要全局视图，再分不同的粒度来找原因。

1、在长期统计的页面加载延迟时间数据集中找到异常点

2、找到该异常点页面加载过程中系统每部分的变化，找到延迟原因是浏览器执行时间和资源获取时间（CSS，JS等）提高了。 

3、诊断资源加载时间的变化，发现CSS预测精度下降5％，页面需要显示另外10kBCSS

4、以页面的不同部分为粒度进行分析，UserInput页面部分已将另外10kB的CSS添加到页面加载关键路径

工程师重新配置早期冲洗机制

### 4.Challenges

很难预测有用的信息或工程师在分析中采取的步骤——Canopy的目标是允许人类生成的假设被快速测试和证明或反驳

1、以一种更加灵活的追踪模式来获取轨迹，并直接对痕迹中的有意义的高级概念进行编码，以便跟踪跨系统组件中正确相互操作，并且更加准确的获取易于理解的性能数
据

2、轨迹太多、以追踪粒度进行查询，所以必须切片、分组、过滤、聚合和总结基于任意特征的轨迹，以达到实时查询和减少复杂查询的目的

3、信息过载，用户应该能够通过最简单的方法，获取适合其特定任务的角度来查看轨迹，在支持跨多个组件的问题的端到端分析的同时，支持钻取单个跟踪的最低级别细节

### 3.总体设计

将关注点放到请求的端到端的执行路径上，在请求的端到端执行路径中记录因果关联的性能数据

1、端到端执行路径的性能数据

2、结构化、因果关联的执行跟踪，扩展X-Trace、Dapper，利用传播标识符获取跨组件关联信息

输入：开发人员可以从轨迹的采样、提取和可视化进行深入定制，进行实时查询

输出：聚合了数十亿个请求的性能数据集，可视化便于分析

### 5.Design
Canopy通过一个完整的管道从堆栈中的系统生成的跟踪中提取性能数据，包括浏览器，移动应用程序和后端服务。 Canopy强调了管道每一步的定
制，并且提供了组件之间关注的新颖分离，以允许它们的单独进化。 

在开发阶段，Facebook工程师可以使用针对不同执行模式量身定制的一系列API来调整系统。 
在运行时，Canopy将生成的性能数据映射到灵活的基于事件的表示。 
Canopy的后端管道在近距离接收事件; 重构分析查询更加便利的高级跟踪模型; 从痕迹中提取用户指定的特征; 并将结果输出到用于自定义聚合可视化的数据集

### 4.优点
1、用于跟踪的解耦设计将仪器与跟踪模型分离开，实现独立演进和不同执行模型的组合。

2、完整的管道，将轨迹转换为自定义的一组提取的特征，以实现快速分析。

3、一组可定制的跟踪组件，用于为不同的用例提供相同数据的多个视图。


